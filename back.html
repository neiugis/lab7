<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Lab 7 - Spatiotemporal Proportional Symbols </title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/business-casual.css" rel="stylesheet">

    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="font-awesome/css/font-awesome-animation.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Slab:100,300,400,600,700,100italic,300italic,400italic,600italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div class="brand">Lab 7. <br> Spatiotemporal Proportional Symbols</div><br>
    <div class="address-bar">GES 387 - Interactive Cartography</div>

    <div class="container">

        <div class="row">
            <div class="box">

                <div class="col-lg-12 text-center" style="text-align:left">
                  <iframe  src="https://neiugis.github.io/timeslider/" width=100% height=550 frameborder=0></iframe>

                  <h3 >IMPORTANT: for this lab, please use <span style="color: red">Firefox</span> to see the animated symbols!</h3>
                  <h3>Overview</h3>
                        <p><i class="fa fa-spinner fa-spin"></i>  In this lab, we will create animated proportional symbols using Leaflet to represent changes over time (see example above). This exercise is modified from <a href="http://www.cartographicperspectives.org/index.php/journal/article/view/cp76-donohue-et-al/1307" target="_blank">this tutorial</a>.</p>
                        <p><i class="fa fa-spinner fa-spin"></i>  Please submit your assignment via Dropbox on D2L according to the requirements in the <a href="#hw"><b>Deliverables</b></a> section.</p>
                        <p style="color:red"><b><i class="fa fa-spinner fa-spin"></i>  Due: 11:59 pm, Friday, 12/2</b></p>

                      <h3><i class="fa fa-paint-brush"></i> Prepare Time Series Data</h3>
                    <p>The first step for the spatiotemporal visualization is to create a time series dataset. For this lab, we'll map <b>population dynamics of fifteen major U.S. cities</b> (You are free to use other spatiotemporal datasets if you prefer). Below is an example of what the data should look like (a <b>.csv</b> file): </p>
                    <center><img src="img/table.png" width=85%></center>
                    <ul>
                        <li>Click <a href="https://drive.google.com/file/d/0BzvZaHCgmEmNTTVBRnZyQjRtVnM/view?usp=sharing" target="_blank" style="font-weight:bold">here</a> to download the csv file. Spend some time to make sure you understand the data structure (you will need to modify the data for answering Question 2).</li>
                        <li>In your web browser, go to <a href="http://geojson.io" target="_blank">geojson.io</a>, select <b>Open - File</b> (see image below) to open the csv file you have just downloaded. </li><br>
                        <center><img src="img/open.png" width=95%></center>
                        <li>The data, <i>i.e., 15 cities</i>, should have been loaded as points/markers.</li>
                        <li>Next, click <b>Save - GeoJSON</b> to save the data as a geojson file.</li><br>
                        <center><img src="img/sve.png" width=95%></center>
                        <li>The last step is to <b>CHANGE THE FILE EXTENSION</b> of map.geojson from .geojson to <b><CODE>.json</CODE></b> (The map.geojson should be found in the Downloads folder). If you are not sure how to change file extension, you may open the geojson file in Atom and then choose Save As to save the file as <code>map.json</code> file to your lab folder.</li>

                    </ul>

                    <h3><i class="fa fa-paint-brush"></i> The HTML</h3>
                    <p>Now, it's time to create the html file. Again, I have attached below the entire html document. </p>

                        <ul>
                        <li>Copy and paste the html code below to your code editor and save the file as <code>map7.html</code> in your lab folder.</li>
                        <li>To make your own animation, your may  modify the <span style="color:red; font-weight:bold">red parts</span>. Please read the <span style="color:blue; font-weight:bold">comment lines in blue</span> for explanations. Note I have only included the most relevant explanations. You are encouranged to visit <a href="http://www.cartographicperspectives.org/index.php/journal/article/view/cp76-donohue-et-al/1307" target="_blank">this link</a> to learn more.

                    <pre>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;Leaflet Prop Symbol Map&lt;/title&gt;

    &lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css"/&gt;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"&gt;&lt;/script&gt;

    &lt;script src="https://code.jquery.com/jquery-3.1.1.min.js"&gt;&lt;/script&gt;
    &lt;script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div id="map" style="height: 650px"&gt;&lt;/div&gt;

    &lt;script&gt;
        var map = L.map('map').setView([37.8, -96], 4);

        L.tileLayer('https://api.tiles.mapbox.com/v4/&#123;id&#125;/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png?access_token=&#123;accessToken&#125;', &#123;
          attribution: 'Map data &amp;copy; &lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt; contributors, &lt;a href="http://creativecommons.org/licenses/by-sa/2.0/"&gt;CC-BY-SA&lt;/a&gt;, Imagery &amp;copy; &lt;a href="http://mapbox.com"&gt;Mapbox&lt;/a&gt;',
          id: 'mapbox.light',
          accessToken: '<span style="color: red; font-weight:bold">Your Access Token</span>'
        &#125;).addTo(map);

        <span style="color: blue">// load the timeseries data</span>
        <span style="color: blue">// change the file name to yours</span>
        $.getJSON("<span style="color: red; font-weight:bold">city.json</span>")
        .done(function(data) &#123;
            var info = processData(data);
            createPropSymbols(info.timestamps, data);
            createSliderUI(info.timestamps);
        &#125;);

        <span style="color: blue">// process the data to derive values that will be used later, for example,</span>
        <span style="color: blue">// the timestamp names (i.e., the name of each column) for use in the time slider labels, and </span>
        <span style="color: blue">// the minimum/maximum values across the time series for use in a map legend (extra credit question)</span>
        <span style="color: blue">// no need to change anything for this lab</span>
        function processData(data) &#123;
            var timestamps = [];
            var	min = Infinity;
            var	max = -Infinity;

            for (var feature in data.features) &#123;
                var properties = data.features[feature].properties;

                for (var attribute in properties) &#123;
                    if ( attribute != 'id' &amp;&amp;
                         attribute != 'name' &amp;&amp;
                         attribute != 'lat' &amp;&amp;
                         attribute != 'lon' )
                    &#123;
                        if ( $.inArray(attribute,timestamps) ===  -1) &#123;
                            timestamps.push(attribute);
                        &#125;
                        if (properties[attribute] &lt; min) &#123;
                            min = properties[attribute];
                        &#125;
                        if (properties[attribute] &gt; max) &#123;
                            max = properties[attribute];
                        &#125;
                    &#125;
                &#125;
            &#125;
            return &#123;
                timestamps : timestamps,
                min : min,
                max : max
            &#125;
        &#125;

        <span style="color: blue">// draw the proportional symbols</span>
        function createPropSymbols(timestamps, data) &#123;

            cities = L.geoJson(data, &#123;

                pointToLayer: function(feature, latlng) &#123;

                    return L.circleMarker(latlng, &#123;
                        fillColor: '<span style="color:#cc6600; font-weight:bold">#501e65</span>',  <span style="color: blue">// fill color of the circles</span>
                        color: '<span style="color:#cc6600; font-weight:bold">#311e39</span>',      <span style="color: blue">// border color of the circles</span>
                        weight: <span style="color:#cc6600; font-weight:bold">2</span>,             <span style="color: blue">// circle line weight in pixels</span>
                        fillOpacity: <span style="color:#cc6600; font-weight:bold">0.6</span>       <span style="color: blue">// fill opacity (0-1)</span>
                    &#125;).on(&#123;

                        mouseover: function(e) &#123;
                            this.openPopup();
                            this.setStyle(&#123;fillColor: '<span style="color:#cc6600; font-weight:bold">green</span>'&#125;);  <span style="color: blue">// fill color turns green when mouseover</span>
                        &#125;,
                        mouseout: function(e) &#123;
                            this.closePopup();
                            this.setStyle(&#123;fillColor: '<span style="color:#cc6600; font-weight:bold">#501e65</span>'&#125;);  <span style="color: blue">// fill turns original color when mouseout</span>
                        &#125;
                    &#125;);
                &#125;
            &#125;).addTo(map);

            updatePropSymbols(timestamps[0]);

        &#125;

        <span style="color: blue">// resize each circle according to a value in the time series</span>
        function updatePropSymbols(timestamp) &#123;

            cities.eachLayer(function(layer) &#123;

                var props = layer.feature.properties;
                var	radius = calcPropRadius(props[timestamp]);

                <span style="color: blue">// pop-up information (when mouseover) for each city is also defined here</span>
                var	popupContent = "&lt;b&gt;" + <span style="color:#cc6600; font-weight:bold">timestamp</span> + ' population: ' + <span style="color:#cc6600; font-weight:bold">String(props[timestamp])</span> + "&lt;/b&gt;&lt;br&gt;" +
                                   "&lt;i&gt;" + props.<span style="color:#cc6600; font-weight:bold">name</span> + "&lt;/i&gt; " ;

                layer.setRadius(radius);
                layer.bindPopup(popupContent, &#123; offset: new L.Point(0,-radius) &#125;);
            &#125;);
        &#125;

        <span style="color: blue">// calculate the radius of the proportional symbols based on area</span>
        function calcPropRadius(attributeValue) &#123;

            var scaleFactor = <span style="color:#cc6600; font-weight:bold">0.002</span>,   <span style="color: blue">// the scale factor is used to scale the values</span>
                                       <span style="color: blue">// the units of the radius are in meters </span>
                                       <span style="color: blue">// determine the scale factor based on the value range and the mapping scale</span>
                area = attributeValue * scaleFactor;

            return Math.sqrt(area/Math.PI);
        &#125;

        <span style="color: blue">// add the temporal slider, no need to change anything for this lab</span>
        <span style="color: blue">// here we use the HTML5 range type to create a simple slider</span>
        function createSliderUI(timestamps) &#123;

            var sliderControl = L.control(&#123; position: '<span style="color:#cc6600">bottomleft</span>'&#125; ); <span style="color: blue">// position of the slider</span>

            sliderControl.onAdd = function(map) &#123;

                var slider = L.DomUtil.create("input", "range-slider");

                L.DomEvent.addListener(slider, 'mousedown', function(e) &#123;

                    L.DomEvent.stopPropagation(e);

                &#125;);

                $(slider)
                    .attr(&#123;'type':'range', 'max': timestamps[timestamps.length-1], 'min':timestamps[0], 'step': 10,'value': String(timestamps[0])&#125;)
                    .on('input change', function() &#123;
                        updatePropSymbols($(this).val().toString());
                        $(".temporal-legend").text(this.value);
                    &#125;);

                return slider;
            &#125;

            sliderControl.addTo(map);
            createTemporalLegend(timestamps[0]);
        &#125;

        <span style="color: blue">// add labels for the temporal slider, no need to change anything for this lab</span>
        function createTemporalLegend(startTimestamp) &#123;

            var temporalLegend = L.control(&#123; position: '<span style="color:#cc6600">bottomleft</span>' &#125;); <span style="color: blue">// same position as the slider</span>

            temporalLegend.onAdd = function(map) &#123;

                var output = L.DomUtil.create("output", "temporal-legend");

                return output;
            &#125;

            temporalLegend.addTo(map);
            $(".temporal-legend").text(startTimestamp);
        &#125;

&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre>
</li> </ul>

                <br>
                <h2 >Deliverables (<a href="#top" style="font-weight:normal; text-decoration:underline">Back to Top <i class="fa fa-arrow-circle-up faa-float animated" aria-hidden="true"></i></a>)</h2>

                <ul id="hw">
                  <li><b>Question 1:</b> Submit BOTH the <code><b>json</b></code> file AND the <code><b>html</b></code> file you have just created by following along the instructions (9 pts).</li>
                  <li><b>Question 2:</b> Edit the original csv file in MS Excel to add <b>1940 population data</b> for all the 15 cities. <br>For simplicity, you can use <a href ="https://en.wikipedia.org/wiki/1940_United_States_Census" target="_blank">the 1940 Census Wikipedia page</a> to find out the population count for each city (the City rankings section; And the 1940 population of Phoenix is <b>65414</b>, which is not in the list). <br>You will need to <b>insert the column before (to the left of) the 1950 data</b> in the table. Then create a json file with the name <code><b>pop40.json</b></code>. Submit the json file (6 pts). </li>
                  <li><b>Question 3:</b> Save the html file as <code><b>pop40.html</b></code>. To receive full credits for this question, modify the code to: <br><b>(1)</b> map the <code><b>pop40.json</b></code> data; <br><b>(2)</b> change the <b>scale factor</b> for resizing the symbols that can better render the data; and <br><b>(3)</b> change the <b>popup content</b> to the form of <b>city name: population count</b> (e.g., Chicago: 2695598) (10 pts). </li>
                  <li><b>Extra Credits:</b> Create a <b>map legend for the proportional symbols</b> (<i>Hint: You may visit <a href="http://www.cartographicperspectives.org/index.php/journal/article/view/cp76-donohue-et-al/1307" target="_blank">this tutorial</a> and see <b>Step 8</b> to learn how</i>; <br>Note if you copy the code from the tutorial, you will have to fix the curly quotes to straight quotes to make it work.)  <br>(3 pts). </li>
                </ul><br>
                </div>
            </div>
        </div>
    </div>
    <!-- /.container -->


    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <p>Copyright &copy; Ting Liu 2016</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

</body>

</html>
